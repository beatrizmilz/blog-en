{
  "hash": "ca78760244fe259be9f1b1a6b5ee4946",
  "result": {
    "markdown": "---\ntitle: \"Monitoring quarto-dev repositories: Creating a workflow with GitHub Actions for R users\"\nsubtitle: \"GitHub Actions Series 2 - In this post, I will show how you can create a workflow to monitor repositories from the quarto-dev organization on GitHub!\"\nauthor: \"Beatriz Milz\"\ndate: \"2022-07-10\"\ncategories: [\"Git\", \"GitHub\", \"GitHub Actions\", \"Automations\", \"RStudio\"]\nimage: \"featured.png\"\ntoc: true\ndraft: false\n---\n\n<a href=\"../en/index.qmd\"> <button type=\"button\" class=\"btn btn-primary\">English</button></a>\n\n\n::: callout-tip\n\nHi! Since I wrote this blogpost, I learned awesome new stuff. So I updated this post in september 2022, to document easier practises with Actions :) While I updated the post, I also renamed the directory `01-rscript` to  `01-monitoring-quarto-repos`, but didn't update the images :( So keep that in mind!\n:::\n\n\nHi!\n\nThis is the second blog post in the \"GitHub Action\" Series. We are two weeks from the start of [RStudio Conference - rstudio::conf 2022](https://www.rstudio.com/conference/), and this post series is complementary material for the lightning talk that I will present!\n\n[![](featured.png){fig-align=\"center\" width=\"70%\"}](https://rstudioconf2022.sched.com/event/11ia9?iframe=no)\n\nIf you have not read the earlier post in this series yet, I recommend reading it before continuing on this post:\n\n-   [Introduction to GitHub Actions to R users](/posts/series-gha/2022-series-gha-1-what-is/en/) - this post is a good introduction on how GitHub Actions works!\n\n## What we will talk about in this post\n\nThis post is a tutorial on how to use GitHub Actions with an R script, using GitHub on a browser :) We will write a GitHub Action workflow that runs an R script to collect data about the repositories in the [quarto](https://github.com/quarto-dev/) organizations and save the result into the GitHub repository.\n\n-   [ ] Create a GitHub Account\n\n-   [ ] Create a repository\n\n-   [ ] Create a `README.md` file (this is optional)\n\n-   [ ] Create an R Script\n\n-   [ ] Create the workflow\n\n-   [ ] Watch your awesome automation run\n\n## Creating your first workflow\n\n### Create a GitHub account\n\nTo start using GitHub Actions, first, you need to have an account on [GitHub](https://github.com/). You can create a new account for free! You also can sign in to your existing account if you already have one.\n\n### Create a repository\n\nGitHub Actions workflows work within a repository. So, the next step is to create one!\n\nIf you don't know what a repository is, imagine having a directory on your computer, and you store files from a project in that directory. A repository is like that but in the cloud!\n\nTo create a repository, on the homepage of GitHub, click on the \"+\" icon in the top right corner and select [New repository](https://github.com/new). Give your repository a name, then choose whether you want it to be public or private. Then click \"Create repository\".\n\n![](images/create-repo.png){fig-align=\"center\"}\n\nFor this example, I created a repository called [awesome-gha](https://github.com/beatrizmilz/awesome-gha).\n\n### Create a `README.md` file\n\nNow that we have a repository, we can start creating and adding files to it. There are multiple ways you can interact with GitHub: you can use Git on command line, or clone the repository to your machine and use the RStudio Git Pane, for example. For this post, I will use GitHub in the browser, so even if you are not used to using Git on your machine, it will be possible to follow along.\n\nFirst, click on \"Creating a new file\":\n\n![](images/repo.png){fig-align=\"center\"}\n\nThen, add a name for the file: let's create a file called `README.md`. This file is the first thing people see when accessing your repository, so adding some information about your project is nice. Then, you can add text and Markdown code in the \"Edit new file\" section, and finally, click on \"Commit new file\" to save your changes.\n\n![](images/commit.png){fig-align=\"center\"}\n\nAwesome! We have a repository, and now we can start working on our GitHub Actions.\n\n![](images/readme.png){fig-align=\"center\"}\n\n### Create an R Script\n\nNow we can start creating an R script. For a first GitHub Action, it is nice to start with something simple so we understand what is going on. To create a new file, click on \"Add file\" and then choose \"Create new file\":\n\n![](images/create-new-file.png){fig-align=\"center\"}\n\nIn this example, I created an R script in the path `01-monitoring-quarto-repos/script.R` and added this code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(\"Hi! Welcome to a GH Actions with an R example :)\")\n\n\n# get information about the repositories on the Quarto organizations.\n\nquarto_orgs <- c(\"quarto-dev\", \"quarto-ext\", \"quarto-journals\")\n\nquarto_repos_raw <-\n  purrr::map(quarto_orgs, ~ gh::gh(\n  \"GET /orgs/{org}/repos\",\n  org = .x,\n  type = \"public\",\n  sort = \"updated\",\n  per_page = 100\n))\n\n\n# transform into a tibble with few cols\nquarto_repos <- quarto_repos_raw |>\n  purrr::flatten() |>\n  purrr::map(unlist, recursive = TRUE)  |>\n  purrr::map_dfr(tibble::enframe, .id = \"id_repo\") |>\n  tidyr::pivot_wider() |>\n  dplyr::transmute(\n    name,\n    url = html_url,\n    description,\n    stars = as.numeric(stargazers_count),\n    forks = as.numeric(forks_count),\n    open_issues = as.numeric(open_issues_count)\n  ) |>\n  dplyr::arrange(dplyr::desc(stars))\n\n\n# write CSV file with the result\nquarto_repos |>\n  readr::write_csv(\"01-monitoring-quarto-repos/quarto_repos.csv\")\n\n# write the README.md file\n\n# create table to add on README\ntable <- quarto_repos |>\n  dplyr::mutate(description = tidyr::replace_na(description, \"\")) |>\n  knitr::kable()\n\n# Write the content on README\npaste0(\n  \"# Repositories from quarto-dev\nMade by [Bea Milz](https://twitter.com/beamilz).\nUpdated with GitHub Actions in \",\nformat(Sys.Date(), '%b %d %Y'),\n\".\n<hr> \\n\n\",\npaste(table, collapse = \"\\n\")\n) |> writeLines(\"01-monitoring-quarto-repos/README.md\")\n\nprint(\"The end! Congrats!\")\n```\n:::\n\n\nCode available here: <https://github.com/beatrizmilz/awesome-gha/blob/main/01-monitoring-quarto-repos/script.R>\n\nTo save the file in this path, type `01-rscript/script.R` in the blank space for the file's name. GitHub will understand that we want to create a directory called `01-rscript` and then write a file called `script.R` inside this directory. Copy and paste the code above and click on the green button that says \"Commit new file\".\n\n![](images/create-new-file2.png){fig-align=\"center\"}\n\nBut what does this code do? First, we need to install all the packages required by the code to run. Then, it accesses the GitHub API and gets information about the public repositories in [quarto](https://github.com/quarto-dev/) organizations. Then, it transforms the collected data and creates a nice table. It writes a CSV with the table and also writes in a `README.md` file! But for now, we only created this file, and to run with GHA, we need to create a file to store the workflow.\n\n### Create the workflow\n\nWe store the workflow in a YAML file that defines when and how the action should run.\n\nBut before we create this file, let's understand what the code does!\n\n### Events\n\nFirst, we need to write the events. The events store information about what can start this workflow!\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\non:\n  schedule: \n    - cron:  \"0 9 * * *\" \n  workflow_dispatch:\n```\n:::\n\n\nIn this example, we will use two events:\n\n-   [Schedule](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule): We can set a workflow to start at a scheduled time. I always use a website called [crontab guru](https://crontab.guru/) and its [examples](https://crontab.guru/examples.html) to find out how to write schedule that I want in *cron* syntax! In this example, I wrote `\"0 9 * * *\"`, and according to [crontab guru](https://crontab.guru/) this workflow will be activated every day at 9 am UTC:\n\n![](images/crontab-guru.png){fig-align=\"center\"}\n\n-   [Workflow dispatch](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch): this event allows us to activate the workflow any time that we want. We need to **press a button** on the GitHub website (I will show a print screen soon), or request the activation using the GitHub API (this example I'll leave for future posts!).\n\n### Name\n\nWe need to give the workflow a name (don't use special characters, let's keep it simple!).\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\nname: 01-rscript\n```\n:::\n\n\n### Jobs\n\nThe jobs describe what the computer should do! In this example, we will install R on an Ubuntu machine, run the script and then save the results in the repository.\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\njobs:\n  run-r-script:\n    runs-on: ubuntu-latest # use Ubuntu\n    env:\n      # The GitHub token will be available \n      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }} \n    steps:\n      # imports an action from another repository, \n      # that enables the machine\n      # to access the code inside our repository\n      - uses: actions/checkout@v3 \n      # imports an action from another repository, \n      # that installs R on the machine\n      - uses: r-lib/actions/setup-r@v2\n        with:\n          # uses the RStudio Package Manager\n          use-public-rspm: true\n\n        \n      # imports an action from another repository, \n      # that deals with the dependencies\n      - uses: r-lib/actions/setup-r-dependencies@v2\n        with: \n          # here we have to add all the packages we used in the script!\n          packages: |\n            any::gh\n            any::dplyr\n            any::tidyr\n            any::readr\n            any::knitr   \n\n      - name: Execute Script\n        # executes the RScript stored in the file\n        # 01-monitoring-quarto-repos/script.R\n        run: |\n          Rscript \"01-monitoring-quarto-repos/script.R\"                        \n\n        # save the results in the repository\n        # using git in the command line\n      - name: Commit results\n        run: |\n          git config --local user.email \"actions@github.com\"\n          git config --local user.name \"GitHub Actions\"\n          git add .\n          git commit -m \"Results from R script\" || echo \"No changes to commit\"\n          git push origin || echo \"No changes to commit\"\n```\n:::\n\n\nThe complete workflow has these three parts: `on:` (the events that start the workflow), `name:` (the name of the repository), and `jobs:` (the instructions for the machine to run).\n\n### We have a workflow!\n\nThis is the complete code for the workflow:\n\n\n::: {.cell}\n\n```{.yaml .cell-code}\non:\n  schedule:\n    - cron:  \"0 9 * * *\"\n  workflow_dispatch:\n\nname: 01-rscript\n\njobs:\n  run-r-script:\n    runs-on: ubuntu-latest\n    env:\n      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}\n    steps:\n      - uses: actions/checkout@v3\n      - uses: r-lib/actions/setup-r@v2\n        with:\n          use-public-rspm: true\n\n      - uses: r-lib/actions/setup-r-dependencies@v2\n        with:\n          packages: |\n            any::gh\n            any::dplyr\n            any::tidyr\n            any::readr\n            any::knitr\n\n      - name: Execute Script\n        run: |\n          Rscript \"01-monitoring-quarto-repos/script.R\"\n\n      - name: Commit results\n        run: |\n          git config --local user.email \"actions@github.com\"\n          git config --local user.name \"GitHub Actions\"\n          git add .\n          git commit -m \"Results from R script\" || echo \"No changes to commit\"\n          git push origin || echo \"No changes to commit\"-\n\n```\n:::\n\n\nNow we need to save this into a `yaml` file. This file must be stored in the `.github/workflows` directory.\n\nTo create a new file, click on \"Add file\" and then choose \"Create new file\":\n\n![](images/create-new-file-3.png){fig-align=\"center\"}\n\nTo save the file in the right path, type `.github/workflows/01-monitoring-quarto-repos.yaml` in the blank space for the file's name. GitHub will understand that we want to create a directory called `.github/`, and then another called `workflows/` inside, and then write a file called `01-monitoring-quarto-repos.yaml` inside this directory.\n\nCopy and paste the code above and click on the green button that says \"Commit new file\".\n\n![](images/create-new-file-4.png){fig-align=\"center\"}\n\nCode available here: <https://github.com/beatrizmilz/awesome-gha/blob/main/.github/workflows/01-monitoring-quarto-repos.yaml>\n\nNow we have a repository with a `README.md` file, an R script inside the `01-monitoring-quarto-repos/` directory, and a GitHub workflow inside the `.github/workflows/` directory:\n\n![](images/repo-2.png){fig-align=\"center\"}\n\n## Watch your awesome automation run\n\nYAY! Now that we created the files needed, we can first experiment with the `workflow_dispatch` button. I made a quick GIF on how to trigger a GHA with the button:\n\n![](images/gif.gif){fig-align=\"center\"} You can see this page at this link: <https://github.com/beatrizmilz/r-actions-example/runs/7273362628?check_suite_focus=true>\n\nAfter a couple of minutes, we can see that the action succeeded:\n\n![](images/logs.png){fig-align=\"center\"}\n\nWe can check the directory `01-monitoring-quarto-repos`, and there are two new files with the results from the script: [`quarto_repos.csv`](https://github.com/beatrizmilz/awesome-gha/blob/main/01-monitoring-quarto-repos/quarto_repos.csv) and [`README.md`](https://github.com/beatrizmilz/awesome-gha/tree/main/01-monitoring-quarto-repos#readme). In this `README.md`, we can monitor the repositories in the [quarto](https://github.com/quarto-dev/) organizations and see which are the most popular repositories!\n\n![](images/after-workflow.png){fig-align=\"center\"}\n\nSee the complete list here: <https://github.com/beatrizmilz/awesome-gha/tree/main/01-monitoring-quarto-repos#readme>\n\n::: callout-tip\n## What if it does not work!?\n\nThe workflow can fail if everything is not correct. For example, the workflow will fail if we forget to install a package used in the script. If this happens, you will probably receive an email from GitHub with an alert.\n\nBut don't be scared! This is pretty common. When I started using GHA in 2020, I got several failures before success. My tip in these cases is: to breathe, be calm, read the logs (the text on the black page I showed in the GIF above) and start debugging.\n:::\n\n## See you in the next post!\n\nI hope this post was useful to you!\n\nStay tuned!\n\n## References\n\n-   [All the files created in this repository are available here](https://github.com/beatrizmilz/awesome-gha)\n\n-   [GitHub Actions](https://github.com/features/actions)\n\n-   [Package usethis](https://usethis.r-lib.org/reference/github_actions.html)\n\n-   [r-lib/actions Repository](https://github.com/r-lib/actions/tree/v2-branch/examples#readme)\n\n-   [GitHub documentation about workflows](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)\n\n-   [Understanding the workflow file](https://docs.github.com/en/actions/using-workflows/about-workflows#understanding-the-workflow-file)\n\nThanks for reviewing the post, [Julio Trecenti](https://github.com/jtrecenti)!\n\n## Share and support!\n\nIf you like these kind of content, consider supporting me at [GitHub Sponsors](https://github.com/sponsors/beatrizmilz/), or sharing it on Twitter.\n\n<center>\n\n<blockquote class=\"twitter-tweet\">\n\n<p lang=\"en\" dir=\"ltr\">\n\n2 WEEKS UNTIL <a href=\"https://twitter.com/hashtag/rstudioconf2022?src=hash&amp;ref_src=twsrc%5Etfw\">#rstudioconf2022</a>!ðŸŽ‰<br><br>The 2nd post about using GitHub Actions for R users is out!<br>I show how to write a workflow that uses R to collect data about the repos by <a href=\"https://twitter.com/quarto_pub?ref_src=twsrc%5Etfw\">@quarto_pub</a> on GitHub and save the results!<a href=\"https://t.co/4Y6HkyZwgx\">https://t.co/4Y6HkyZwgx</a><a href=\"https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw\">#rstats</a> <a href=\"https://twitter.com/hashtag/github?src=hash&amp;ref_src=twsrc%5Etfw\">#github</a> <a href=\"https://twitter.com/hashtag/rstudioconf?src=hash&amp;ref_src=twsrc%5Etfw\">#rstudioconf</a> <a href=\"https://twitter.com/rstudio?ref_src=twsrc%5Etfw\">@rstudio</a>\n\n</p>\n\n--- Beatriz Milz (@BeaMilz) <a href=\"https://twitter.com/BeaMilz/status/1546457734790483969?ref_src=twsrc%5Etfw\">July 11, 2022</a>\n\n</blockquote>\n\n\n```{=html}\n<script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>\n```\n\n</center>\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}